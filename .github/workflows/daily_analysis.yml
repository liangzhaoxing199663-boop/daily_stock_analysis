name: 'Daily Stock Analysis'

on:
  push:
    branches:
      - master
      - main
  schedule:
    # æ¯å¤© 5 æ¬¡
    - cron: '0 0 * * *'
    - cron: '0 5 * * *'
    - cron: '0 10 * * *'
    - cron: '30 12 * * *'
    - cron: '0 16 * * *'
  workflow_dispatch:

jobs:
  daily_analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          # å¿…é¡»ä¿ç•™çš„é›…è™è´¢ç»è¡¥ä¸
          pip install yfinance pandas_datareader requests urllib3 --upgrade --no-cache-dir

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€æ ¸å¿ƒä¿®å¤ã€‘ç”¨ Python è„šæœ¬å¼ºè¡Œä¿®æ”¹æºä»£ç  ğŸ‘‡ğŸ‘‡ğŸ‘‡
      # è¿™æ˜¯ä¸€ä¸ªâ€œå¤–ç§‘æ‰‹æœ¯â€è„šæœ¬ï¼Œä¸“é—¨æ²» 429 é™æµ
      - name: ğŸ¢ Force Serial Processing (Limit Workers to 1)
        run: |
          python -c "
          import os
          print('æ­£åœ¨æ‰§è¡Œä»£ç ä¿®å¤æ‰‹æœ¯...')
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.py'):
                      path = os.path.join(root, file)
                      with open(path, 'r', encoding='utf-8') as f:
                          content = f.read()
                      
                      # 1. å¼ºè¡ŒæŠŠ 3å¹¶å‘ æ”¹æˆ 1å¹¶å‘ (æ’é˜Ÿæ¨¡å¼)
                      new_content = content.replace('max_workers=3', 'max_workers=1')
                      new_content = new_content.replace('max_workers = 3', 'max_workers = 1')
                      
                      # 2. å¼ºè¡ŒæŠŠæ—§æ¨¡å‹æ›¿æ¢æˆ 1.5-flash
                      new_content = new_content.replace('gemini-3-flash-preview', 'gemini-1.5-flash')
                      new_content = new_content.replace('gemini-2.5-flash', 'gemini-1.5-flash')
                      
                      if new_content != content:
                          print(f'å·²ä¿®å¤æ–‡ä»¶: {path}')
                          with open(path, 'w', encoding='utf-8') as f:
                              f.write(new_content)
          print('æ‰‹æœ¯å®Œæˆï¼ç°åœ¨æ˜¯å•çº¿ç¨‹æ’é˜Ÿæ¨¡å¼ï¼Œç»å¯¹ç¨³ï¼')
          "

      - name: Run analysis
        env:
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          
          # ç¯å¢ƒå˜é‡åŒé‡é”å®š
          LLM_MODEL: gemini-1.5-flash
          GOOGLE_API_KEY: ${{ secrets.LLM_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.LLM_API_KEY }}
          
        run: python main.py
